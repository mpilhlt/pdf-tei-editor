#!/usr/bin/env python3

# CLI for running the FastAPI server in development mode with auto-reload.

import os
import sys
import subprocess
from pathlib import Path

# Add project root to path for imports
project_root = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(project_root))

from fastapi_app.lib.server_startup import (
    load_environment,
    check_port_in_use,
    get_pid_on_port,
    get_host_and_port,
    setup_log_directory,
    print_server_running_message,
    print_server_starting_message,
    kill_server_on_port
)


if __name__ == '__main__':
    # Load environment variables
    load_environment(project_root)

    # Check for --restart flag and remove it from sys.argv before parsing host/port
    restart = '--restart' in sys.argv
    if restart:
        sys.argv.remove('--restart')

    # Get host and port
    host, port = get_host_and_port()

    # Check if server is already running
    if check_port_in_use(port):
        if restart:
            kill_server_on_port(port)
        else:
            pid = get_pid_on_port(port)
            print_server_running_message(host, port, pid)
            sys.exit(0)

    # Set up logging
    log_file = setup_log_directory(project_root)

    # On Windows, uvicorn's auto-reload doesn't work properly - it shuts down but doesn't restart
    # See: https://github.com/fastapi/fastapi/discussions/13817
    # Disable auto-reload by default on Windows unless explicitly enabled
    if sys.platform == 'win32':
        disable_reload_default = os.environ.get('ENABLE_RELOAD', '').lower() not in ('1', 'true', 'yes')
    else:
        disable_reload_default = os.environ.get('DISABLE_RELOAD', '').lower() in ('1', 'true', 'yes')

    disable_reload = disable_reload_default

    print_server_starting_message(host, port, log_file, mode="development", auto_reload=not disable_reload)

    # Build uvicorn command
    cmd = [
        'uv', 'run', 'uvicorn',
        'run_fastapi:app',
        '--host', host,
        '--port', str(port),
        '--log-level', 'info',
        '--timeout-graceful-shutdown', '1',  # Force reload after 1 second if connections don't close
        '--reload-delay', '0.25'  # Debounce rapid file changes
    ]

    if not disable_reload:
        cmd.insert(3, '--reload')

    try:
        # Run uvicorn and stream output to log file
        with open(log_file, 'w', buffering=1) as log_f:
            process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                bufsize=1,
                cwd=str(project_root)
            )

            # Stream output to both console and log file
            for line in process.stdout: # type:ignore
                print(line, end='')
                log_f.write(line)
                log_f.flush()

            process.wait()

    except KeyboardInterrupt:
        print("\nShutting down FastAPI server...")
        if 'process' in locals() and hasattr(process, 'terminate'):
            process.terminate()
            process.wait()
    except Exception as e:
        print(f"Error starting FastAPI server: {e}", file=sys.stderr)
        sys.exit(1)
