#!/usr/bin/env python3

# CLI for running the FastAPI server in production mode with uvicorn.

import os
import sys
import subprocess
from pathlib import Path

# Add project root to path for imports
project_root = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(project_root))

from fastapi_app.lib.utils.server_startup import (
    load_environment,
    check_port_in_use,
    get_pid_on_port,
    get_host_and_port,
    setup_log_directory,
    print_server_running_message,
    print_server_starting_message,
    kill_server_on_port
)


if __name__ == '__main__':
    # Load environment variables
    load_environment(project_root)

    # Check for --restart flag and remove it from sys.argv before parsing host/port
    restart = '--restart' in sys.argv
    if restart:
        sys.argv.remove('--restart')

    # Get host and port
    host, port = get_host_and_port()

    # Check if server is already running
    if check_port_in_use(port):
        if restart:
            kill_server_on_port(port)
        else:
            pid = get_pid_on_port(port)
            print_server_running_message(host, port, pid)
            sys.exit(0)

    # Set up logging
    log_file = setup_log_directory(project_root)
    print_server_starting_message(host, port, log_file, mode="production")

    # Build uvicorn command for production
    # On Linux/Mac, use venv python directly for better performance
    # On Windows, use uv run (required for proper activation)
    log_config = str(project_root / 'fastapi_app' / 'log_config.json')
    if sys.platform == 'win32':
        # Windows: use uv run with UV_NO_SYNC to prevent hanging
        os.environ['UV_NO_SYNC'] = '1'
        cmd = [
            'uv', 'run', 'uvicorn',
            'run_fastapi:app',
            '--host', host,
            '--port', str(port),
            '--log-level', 'info',
            '--log-config', log_config,
            '--timeout-graceful-shutdown', '5',
            '--workers', '4'
        ]
    else:
        # Linux/Mac: use venv python directly
        venv_python = project_root / '.venv' / 'bin' / 'python'
        cmd = [
            str(venv_python), '-m', 'uvicorn',
            'run_fastapi:app',
            '--host', host,
            '--port', str(port),
            '--log-level', 'info',
            '--log-config', log_config,
            '--timeout-graceful-shutdown', '5',
            '--workers', '4'
        ]

    try:
        # Run uvicorn and tee output to log file
        # In test environment, log only to file to keep console clean
        test_mode = os.environ.get('TEST_IN_PROGRESS')

        with open(log_file, 'w', buffering=1) as log_f:
            if test_mode:
                # Test mode: log only to file
                process = subprocess.Popen(
                    cmd,
                    stdout=log_f,
                    stderr=subprocess.STDOUT,
                    cwd=str(project_root)
                )
                process.wait()
            else:
                # Normal production: tee to both console and file
                process = subprocess.Popen(
                    cmd,
                    stdout=subprocess.PIPE,
                    stderr=subprocess.STDOUT,
                    text=True,
                    bufsize=1,
                    cwd=str(project_root)
                )

                # Stream output to both console and log file
                for line in process.stdout: # type:ignore
                    print(line, end='')
                    log_f.write(line)
                    log_f.flush()

                process.wait()

    except KeyboardInterrupt:
        print("\nShutting down FastAPI server...")
        if process:
            process.terminate()
            process.wait()
    except Exception as e:
        print(f"Error starting FastAPI server: {e}", file=sys.stderr)
        sys.exit(1)
